<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Usage &mdash; delta-rs  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Reference" href="api_reference.html" />
    <link rel="prev" title="Installation" href="installation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            delta-rs
          </a>
              <div class="version">
                0.12.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#loading-a-delta-table">Loading a Delta Table</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-storage-backends">Custom Storage Backends</a></li>
<li class="toctree-l3"><a class="reference internal" href="#time-travel">Time Travel</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#examining-a-table">Examining a Table</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#metadata">Metadata</a></li>
<li class="toctree-l3"><a class="reference internal" href="#schema">Schema</a></li>
<li class="toctree-l3"><a class="reference internal" href="#history">History</a></li>
<li class="toctree-l3"><a class="reference internal" href="#current-add-actions">Current Add Actions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#querying-delta-tables">Querying Delta Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#managing-delta-tables">Managing Delta Tables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#vacuuming-tables">Vacuuming tables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#optimizing-tables">Optimizing tables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#writing-delta-tables">Writing Delta Tables</a></li>
<li class="toctree-l2"><a class="reference internal" href="#updating-delta-tables">Updating Delta Tables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#overwriting-a-partition">Overwriting a partition</a></li>
<li class="toctree-l3"><a class="reference internal" href="#removing-data">Removing data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#restoring-tables">Restoring tables</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api_reference.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">delta-rs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Usage</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/delta-io/delta-rs/blob/main/python/docs/source/usage.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this headline"></a></h1>
<p>A <a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable" title="deltalake.table.DeltaTable"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeltaTable</span></code></a> represents the state of a delta table at a particular
version. This includes which files are currently part of the table, the schema
of the table, and other metadata such as creation time.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">DeltaTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/delta-0.2.0&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">version</span><span class="p">()</span>
<span class="go">3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">files</span><span class="p">()</span>
<span class="go">[&#39;part-00000-cb6b150b-30b8-4662-ad28-ff32ddab96d2-c000.snappy.parquet&#39;,</span>
<span class="go"> &#39;part-00000-7c2deba3-1994-4fb8-bc07-d46c948aa415-c000.snappy.parquet&#39;,</span>
<span class="go"> &#39;part-00001-c373a5bd-85f0-4758-815e-7eb62007a15c-c000.snappy.parquet&#39;]</span>
</pre></div>
</div>
<section id="loading-a-delta-table">
<h2>Loading a Delta Table<a class="headerlink" href="#loading-a-delta-table" title="Permalink to this headline"></a></h2>
<p>To load the current version, use the constructor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/delta-0.2.0&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Depending on your storage backend, you could use the <code class="docutils literal notranslate"><span class="pre">storage_options</span></code> parameter to provide some configuration.
Configuration is defined for specific backends - <a class="reference external" href="https://docs.rs/object_store/latest/object_store/aws/enum.AmazonS3ConfigKey.html#variants">s3 options</a>, <a class="reference external" href="https://docs.rs/object_store/latest/object_store/azure/enum.AzureConfigKey.html#variants">azure options</a>, <a class="reference external" href="https://docs.rs/object_store/latest/object_store/gcp/enum.GoogleConfigKey.html#variants">gcs options</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">storage_options</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;AWS_ACCESS_KEY_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;THE_AWS_ACCESS_KEY_ID&quot;</span><span class="p">,</span> <span class="s2">&quot;AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">:</span><span class="s2">&quot;THE_AWS_SECRET_ACCESS_KEY&quot;</span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/delta-0.2.0&quot;</span><span class="p">,</span> <span class="n">storage_options</span><span class="o">=</span><span class="n">storage_options</span><span class="p">)</span>
</pre></div>
</div>
<p>The configuration can also be provided via the environment, and the basic service provider is derived from the URL
being used. We try to support many of the well-known formats to identify basic service properties.</p>
<p><strong>S3</strong>:</p>
<blockquote>
<div><ul class="simple">
<li><p>s3://&lt;bucket&gt;/&lt;path&gt;</p></li>
<li><p>s3a://&lt;bucket&gt;/&lt;path&gt;</p></li>
</ul>
</div></blockquote>
<p><strong>Azure</strong>:</p>
<blockquote>
<div><ul class="simple">
<li><p>az://&lt;container&gt;/&lt;path&gt;</p></li>
<li><p>adl://&lt;container&gt;/&lt;path&gt;</p></li>
<li><p>abfs://&lt;container&gt;/&lt;path&gt;</p></li>
</ul>
</div></blockquote>
<p><strong>GCS</strong>:</p>
<blockquote>
<div><ul class="simple">
<li><p>gs://&lt;bucket&gt;/&lt;path&gt;</p></li>
</ul>
</div></blockquote>
<p>Alternatively, if you have a data catalog you can load it by reference to a
database and table name. Currently supported are AWS Glue and Databricks Unity Catalog.</p>
<p>For AWS Glue catalog, use AWS environment variables to authenticate.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">DeltaTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">DataCatalog</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">database_name</span> <span class="o">=</span> <span class="s2">&quot;simple_database&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;simple_table&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data_catalog</span> <span class="o">=</span> <span class="n">DataCatalog</span><span class="o">.</span><span class="n">AWS</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">from_data_catalog</span><span class="p">(</span><span class="n">data_catalog</span><span class="o">=</span><span class="n">data_catalog</span><span class="p">,</span> <span class="n">database_name</span><span class="o">=</span><span class="n">database_name</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">to_pyarrow_table</span><span class="p">()</span><span class="o">.</span><span class="n">to_pydict</span><span class="p">()</span>
<span class="go">{&#39;id&#39;: [5, 7, 9, 5, 6, 7, 8, 9]}</span>
</pre></div>
</div>
<dl class="simple">
<dt>For Databricks Unity Catalog authentication, use environment variables:</dt><dd><ul class="simple">
<li><p>DATABRICKS_WORKSPACE_URL (e.g. <a class="reference external" href="https://adb-62800498333851.30.azuredatabricks.net">https://adb-62800498333851.30.azuredatabricks.net</a>)</p></li>
<li><p>DATABRICKS_ACCESS_TOKEN</p></li>
</ul>
</dd>
</dl>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">DataCatalog</span><span class="p">,</span> <span class="n">DeltaTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DATABRICKS_WORKSPACE_URL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;https://adb-62800498333851.30.azuredatabricks.net&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DATABRICKS_ACCESS_TOKEN&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&lt;DBAT&gt;&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">catalog_name</span> <span class="o">=</span> <span class="s1">&#39;main&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">schema_name</span> <span class="o">=</span> <span class="s1">&#39;db_schema&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">table_name</span> <span class="o">=</span> <span class="s1">&#39;db_table&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">data_catalog</span> <span class="o">=</span> <span class="n">DataCatalog</span><span class="o">.</span><span class="n">UNITY</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="o">.</span><span class="n">from_data_catalog</span><span class="p">(</span><span class="n">data_catalog</span><span class="o">=</span><span class="n">data_catalog</span><span class="p">,</span> <span class="n">data_catalog_id</span><span class="o">=</span><span class="n">catalog_name</span><span class="p">,</span> <span class="n">database_name</span><span class="o">=</span><span class="n">schema_name</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="n">table_name</span><span class="p">)</span>
</pre></div>
</div>
<section id="custom-storage-backends">
<h3>Custom Storage Backends<a class="headerlink" href="#custom-storage-backends" title="Permalink to this headline"></a></h3>
<p>While delta always needs its internal storage backend to work and be properly configured, in order to manage the delta log,
it may sometime be advantageous - and is common practice in the arrow world - to customize the storage interface used for
reading the bulk data.</p>
<p><code class="docutils literal notranslate"><span class="pre">deltalake</span></code> will work with any storage compliant with <a class="reference external" href="https://arrow.apache.org/docs/python/generated/pyarrow.fs.FileSystem.html#pyarrow.fs.FileSystem" title="(in Apache Arrow v13.0.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyarrow.fs.FileSystem</span></code></a>, however the root of the filesystem has
to be adjusted to point at the root of the Delta table. We can achieve this by wrapping the custom filesystem into
a <a class="reference external" href="https://arrow.apache.org/docs/python/generated/pyarrow.fs.SubTreeFileSystem.html#pyarrow.fs.SubTreeFileSystem" title="(in Apache Arrow v13.0.0)"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyarrow.fs.SubTreeFileSystem</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyarrow.fs</span> <span class="k">as</span> <span class="nn">fs</span>
<span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">DeltaTable</span>

<span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;&lt;path/to/table&gt;&quot;</span>
<span class="n">filesystem</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">SubTreeFileSystem</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">fs</span><span class="o">.</span><span class="n">LocalFileSystem</span><span class="p">())</span>

<span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">to_pyarrow_dataset</span><span class="p">(</span><span class="n">filesystem</span><span class="o">=</span><span class="n">filesystem</span><span class="p">)</span>
</pre></div>
</div>
<p>When using the pyarrow factory method for file systems, the normalized path is provided
on creation. In case of S3 this would look something like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pyarrow.fs</span> <span class="k">as</span> <span class="nn">fs</span>
<span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">DeltaTable</span>

<span class="n">table_uri</span> <span class="o">=</span> <span class="s2">&quot;s3://&lt;bucket&gt;/&lt;path&gt;&quot;</span>
<span class="n">raw_fs</span><span class="p">,</span> <span class="n">normalized_path</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">FileSystem</span><span class="o">.</span><span class="n">from_uri</span><span class="p">(</span><span class="n">table_uri</span><span class="p">)</span>
<span class="n">filesystem</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="n">SubTreeFileSystem</span><span class="p">(</span><span class="n">normalized_path</span><span class="p">,</span> <span class="n">raw_fs</span><span class="p">)</span>

<span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="n">table_uri</span><span class="p">)</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">to_pyarrow_dataset</span><span class="p">(</span><span class="n">filesystem</span><span class="o">=</span><span class="n">filesystem</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="time-travel">
<h3>Time Travel<a class="headerlink" href="#time-travel" title="Permalink to this headline"></a></h3>
<p>To load previous table states, you can provide the version number you wish to
load:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/simple_table&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>Once you’ve loaded a table, you can also change versions using either a version
number or datetime string:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">load_version</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">load_with_datetime</span><span class="p">(</span><span class="s2">&quot;2021-11-04 00:05:23.283+00:00&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Previous table versions may not exist if they have been vacuumed, in which
case an exception will be thrown. See <a class="reference internal" href="#vacuuming-tables">Vacuuming tables</a> for more information.</p>
</div>
</section>
</section>
<section id="examining-a-table">
<h2>Examining a Table<a class="headerlink" href="#examining-a-table" title="Permalink to this headline"></a></h2>
<section id="metadata">
<h3>Metadata<a class="headerlink" href="#metadata" title="Permalink to this headline"></a></h3>
<p>The delta log maintains basic metadata about a table, including:</p>
<ul class="simple">
<li><p>A unique <code class="docutils literal notranslate"><span class="pre">id</span></code></p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">name</span></code>, if provided</p></li>
<li><p>A <code class="docutils literal notranslate"><span class="pre">description</span></code>, if provided</p></li>
<li><p>The list of <code class="docutils literal notranslate"><span class="pre">partition_columns</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">created_time</span></code> of the table</p></li>
<li><p>A map of table <code class="docutils literal notranslate"><span class="pre">configuration</span></code>. This includes fields such as <code class="docutils literal notranslate"><span class="pre">delta.appendOnly</span></code>,
which if <code class="docutils literal notranslate"><span class="pre">true</span></code> indicates the table is not meant to have data deleted from it.</p></li>
</ul>
<p>Get metadata from a table with the <a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.metadata" title="deltalake.table.DeltaTable.metadata"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.metadata()</span></code></a> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">DeltaTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/simple_table&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">metadata</span><span class="p">()</span>
<span class="go">Metadata(id: 5fba94ed-9794-4965-ba6e-6ee3c0d22af9, name: None, description: None, partitionColumns: [], created_time: 1587968585495, configuration={})</span>
</pre></div>
</div>
</section>
<section id="schema">
<h3>Schema<a class="headerlink" href="#schema" title="Permalink to this headline"></a></h3>
<p>The schema for the table is also saved in the transaction log. It can either be
retrieved in the Delta Lake form as <a class="reference internal" href="api_reference.html#deltalake.schema.Schema" title="deltalake.schema.Schema"><code class="xref py py-class docutils literal notranslate"><span class="pre">deltalake.schema.Schema</span></code></a> or as a PyArrow
schema. The first allows you to introspect any column-level metadata stored in
the schema, while the latter represents the schema the table will be loaded into.</p>
<p>Use <a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.schema" title="deltalake.table.DeltaTable.schema"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.schema()</span></code></a> to retrieve the delta lake schema:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">DeltaTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/simple_table&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span>
<span class="go">Schema([Field(id, PrimitiveType(&quot;long&quot;), nullable=True)])</span>
</pre></div>
</div>
<p>These schemas have a JSON representation that can be retrieved. To reconstruct
from json, use <a class="reference internal" href="api_reference.html#deltalake.schema.Schema.from_json" title="deltalake.schema.Schema.from_json"><code class="xref py py-meth docutils literal notranslate"><span class="pre">deltalake.schema.Schema.from_json()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="go">&#39;{&quot;type&quot;:&quot;struct&quot;,&quot;fields&quot;:[{&quot;name&quot;:&quot;id&quot;,&quot;type&quot;:&quot;long&quot;,&quot;nullable&quot;:true,&quot;metadata&quot;:{}}]}&#39;</span>
</pre></div>
</div>
<p>Use <a class="reference internal" href="api_reference.html#deltalake.schema.Schema.to_pyarrow" title="deltalake.schema.Schema.to_pyarrow"><code class="xref py py-meth docutils literal notranslate"><span class="pre">deltalake.schema.Schema.to_pyarrow()</span></code></a> to retrieve the PyArrow schema:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span><span class="o">.</span><span class="n">to_pyarrow</span><span class="p">()</span>
<span class="go">id: int64</span>
</pre></div>
</div>
</section>
<section id="history">
<h3>History<a class="headerlink" href="#history" title="Permalink to this headline"></a></h3>
<p>Depending on what system wrote the table, the delta table may have provenance
information describing what operations were performed on the table, when, and
by whom. This information is retained for 30 days by default, unless otherwise
specified by the table configuration <code class="docutils literal notranslate"><span class="pre">delta.logRetentionDuration</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This information is not written by all writers and different writers may use
different schemas to encode the actions. For Spark’s format, see:
<a class="reference external" href="https://docs.delta.io/latest/delta-utility.html#history-schema">https://docs.delta.io/latest/delta-utility.html#history-schema</a></p>
</div>
<p>To view the available history, use <a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.history" title="deltalake.table.DeltaTable.history"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.history()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">DeltaTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/simple_table&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">history</span><span class="p">()</span>
<span class="go">[{&#39;timestamp&#39;: 1587968626537, &#39;operation&#39;: &#39;DELETE&#39;, &#39;operationParameters&#39;: {&#39;predicate&#39;: &#39;[&quot;((`id` % CAST(2 AS BIGINT)) = CAST(0 AS BIGINT))&quot;]&#39;}, &#39;readVersion&#39;: 3, &#39;isBlindAppend&#39;: False},</span>
<span class="go"> {&#39;timestamp&#39;: 1587968614187, &#39;operation&#39;: &#39;UPDATE&#39;, &#39;operationParameters&#39;: {&#39;predicate&#39;: &#39;((id#697L % cast(2 as bigint)) = cast(0 as bigint))&#39;}, &#39;readVersion&#39;: 2, &#39;isBlindAppend&#39;: False},</span>
<span class="go"> {&#39;timestamp&#39;: 1587968604143, &#39;operation&#39;: &#39;WRITE&#39;, &#39;operationParameters&#39;: {&#39;mode&#39;: &#39;Overwrite&#39;, &#39;partitionBy&#39;: &#39;[]&#39;}, &#39;readVersion&#39;: 1, &#39;isBlindAppend&#39;: False},</span>
<span class="go"> {&#39;timestamp&#39;: 1587968596254, &#39;operation&#39;: &#39;MERGE&#39;, &#39;operationParameters&#39;: {&#39;predicate&#39;: &#39;(oldData.`id` = newData.`id`)&#39;}, &#39;readVersion&#39;: 0, &#39;isBlindAppend&#39;: False},</span>
<span class="go"> {&#39;timestamp&#39;: 1587968586154, &#39;operation&#39;: &#39;WRITE&#39;, &#39;operationParameters&#39;: {&#39;mode&#39;: &#39;ErrorIfExists&#39;, &#39;partitionBy&#39;: &#39;[]&#39;}, &#39;isBlindAppend&#39;: True}]</span>
</pre></div>
</div>
</section>
<section id="current-add-actions">
<h3>Current Add Actions<a class="headerlink" href="#current-add-actions" title="Permalink to this headline"></a></h3>
<p>The active state for a delta table is determined by the Add actions, which
provide the list of files that are part of the table and metadata about them,
such as creation time, size, and statistics. You can get a data frame of
the add actions data using <a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.get_add_actions" title="deltalake.table.DeltaTable.get_add_actions"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.get_add_actions()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">DeltaTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/delta-0.8.0&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">get_add_actions</span><span class="p">(</span><span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="go">                                                    path  size_bytes   modification_time  data_change  num_records  null_count.value  min.value  max.value</span>
<span class="go">0  part-00000-c9b90f86-73e6-46c8-93ba-ff6bfaf892a...         440 2021-03-06 15:16:07         True            2                 0          0          2</span>
<span class="go">1  part-00000-04ec9591-0b73-459e-8d18-ba5711d6cbe...         440 2021-03-06 15:16:16         True            2                 0          2          4</span>
</pre></div>
</div>
<p>This works even with past versions of the table:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/delta-0.8.0&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">get_add_actions</span><span class="p">(</span><span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="go">                                                path  size_bytes   modification_time  data_change  num_records  null_count.value  min.value  max.value</span>
<span class="go">0  part-00000-c9b90f86-73e6-46c8-93ba-ff6bfaf892a...         440 2021-03-06 15:16:07         True            2                 0          0          2</span>
<span class="go">1  part-00001-911a94a2-43f6-4acb-8620-5e68c265498...         445 2021-03-06 15:16:07         True            3                 0          2          4</span>
</pre></div>
</div>
</section>
</section>
<section id="querying-delta-tables">
<h2>Querying Delta Tables<a class="headerlink" href="#querying-delta-tables" title="Permalink to this headline"></a></h2>
<p>Delta tables can be queried in several ways. By loading as Arrow data or an Arrow
dataset, they can be used by compatible engines such as Pandas and DuckDB. By
passing on the list of files, they can be loaded into other engines such as Dask.</p>
<p>Delta tables are often larger than can fit into memory on a single computer, so
this module provides ways to read only the parts of the data you need. Partition
filters allow you to skip reading files that are part of irrelevant partitions.
Only loading the columns required also saves memory. Finally, some methods allow
reading tables batch-by-batch, allowing you to process the whole table while only
having a portion loaded at any given time.</p>
<p>To load into Pandas or a PyArrow table use the <a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.to_pandas" title="deltalake.table.DeltaTable.to_pandas"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.to_pandas()</span></code></a> and
<a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.to_pyarrow_table" title="deltalake.table.DeltaTable.to_pyarrow_table"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.to_pyarrow_table()</span></code></a> methods, respectively. Both of these
support filtering partitions and selecting particular columns.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">DeltaTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/delta-0.8.0-partitioned&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">schema</span><span class="p">()</span><span class="o">.</span><span class="n">to_pyarrow</span><span class="p">()</span>
<span class="go">value: string</span>
<span class="go">year: string</span>
<span class="go">month: string</span>
<span class="go">day: string</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">(</span><span class="n">partitions</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;2021&quot;</span><span class="p">)],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
<span class="go">      value</span>
<span class="go">0     6</span>
<span class="go">1     7</span>
<span class="go">2     5</span>
<span class="go">3     4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">to_pyarrow_table</span><span class="p">(</span><span class="n">partitions</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="s2">&quot;2021&quot;</span><span class="p">)],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
<span class="go">pyarrow.Table</span>
<span class="go">value: string</span>
</pre></div>
</div>
<p>Converting to a PyArrow Dataset allows you to filter on columns other than
partition columns and load the result as a stream of batches rather than a single
table. Convert to a dataset using <a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.to_pyarrow_dataset" title="deltalake.table.DeltaTable.to_pyarrow_dataset"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.to_pyarrow_dataset()</span></code></a>. Filters
applied to datasets will use the partition values and file statistics from the
Delta transaction log and push down any other filters to the scanning operation.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">pyarrow.dataset</span> <span class="k">as</span> <span class="nn">ds</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dataset</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">to_pyarrow_dataset</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">condition</span> <span class="o">=</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;2021&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">field</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="s2">&quot;4&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dataset</span><span class="o">.</span><span class="n">to_table</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="go">  value</span>
<span class="go">0     6</span>
<span class="go">1     7</span>
<span class="go">2     5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">batch_iter</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">to_batches</span><span class="p">(</span><span class="nb">filter</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">batch_iter</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">())</span>
<span class="go">  value</span>
<span class="go">0     6</span>
<span class="go">1     7</span>
<span class="go">  value</span>
<span class="go">0     5</span>
</pre></div>
</div>
<p>PyArrow datasets may also be passed to compatible query engines, such as <a class="reference external" href="https://duckdb.org/docs/api/python">DuckDB</a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">duckdb</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ex_data</span> <span class="o">=</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">arrow</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ex_data</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s2">&quot;year = 2021 and value &gt; 4&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
<span class="go">---------------------</span>
<span class="go">-- Expression Tree --</span>
<span class="go">---------------------</span>
<span class="go">Projection [value]</span>
<span class="go">  Filter [year=2021 AND value&gt;4]</span>
<span class="go">    arrow_scan(140409099470144, 4828104688, 1000000)</span>

<span class="go">---------------------</span>
<span class="go">-- Result Columns  --</span>
<span class="go">---------------------</span>
<span class="go">- value (VARCHAR)</span>

<span class="go">---------------------</span>
<span class="go">-- Result Preview  --</span>
<span class="go">---------------------</span>
<span class="go">value</span>
<span class="go">VARCHAR</span>
<span class="go">[ Rows: 3]</span>
<span class="go">6</span>
<span class="go">7</span>
<span class="go">5</span>
</pre></div>
</div>
<p>Finally, you can always pass the list of file paths to an engine. For example,
you can pass them to <code class="docutils literal notranslate"><span class="pre">dask.dataframe.read_parquet</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">dask.dataframe</span> <span class="k">as</span> <span class="nn">dd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">dd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">file_uris</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span>
<span class="go">Dask DataFrame Structure:</span>
<span class="go">                value             year            month              day</span>
<span class="go">npartitions=6</span>
<span class="go">               object  category[known]  category[known]  category[known]</span>
<span class="go">                  ...              ...              ...              ...</span>
<span class="gp">... </span>              <span class="o">...</span>              <span class="o">...</span>              <span class="o">...</span>              <span class="o">...</span>
<span class="go">                  ...              ...              ...              ...</span>
<span class="go">                  ...              ...              ...              ...</span>
<span class="go">Dask Name: read-parquet, 6 tasks</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="go">  value  year month day</span>
<span class="go">0     1  2020     1   1</span>
<span class="go">0     2  2020     2   3</span>
<span class="go">0     3  2020     2   5</span>
<span class="go">0     4  2021     4   5</span>
<span class="go">0     5  2021    12   4</span>
<span class="go">0     6  2021    12  20</span>
<span class="go">1     7  2021    12  20</span>
</pre></div>
</div>
</section>
<section id="managing-delta-tables">
<h2>Managing Delta Tables<a class="headerlink" href="#managing-delta-tables" title="Permalink to this headline"></a></h2>
<section id="vacuuming-tables">
<h3>Vacuuming tables<a class="headerlink" href="#vacuuming-tables" title="Permalink to this headline"></a></h3>
<p>Vacuuming a table will delete any files that have been marked for deletion. This
may make some past versions of a table invalid, so this can break time travel.
However, it will save storage space. Vacuum will retain files in a certain window,
by default one week, so time travel will still work in shorter ranges.</p>
<p>Delta tables usually don’t delete old files automatically, so vacuuming regularly
is considered good practice, unless the table is only appended to.</p>
<p>Use <a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.vacuum" title="deltalake.table.DeltaTable.vacuum"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.vacuum()</span></code></a> to perform the vacuum operation. Note that to
prevent accidental deletion, the function performs a dry-run by default: it will
only list the files to be deleted. Pass <code class="docutils literal notranslate"><span class="pre">dry_run=False</span></code> to actually delete files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/simple_table&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">vacuum</span><span class="p">()</span>
<span class="go">[&#39;../rust/tests/data/simple_table/part-00006-46f2ff20-eb5d-4dda-8498-7bfb2940713b-c000.snappy.parquet&#39;,</span>
<span class="go"> &#39;../rust/tests/data/simple_table/part-00190-8ac0ae67-fb1d-461d-a3d3-8dc112766ff5-c000.snappy.parquet&#39;,</span>
<span class="go"> &#39;../rust/tests/data/simple_table/part-00164-bf40481c-4afd-4c02-befa-90f056c2d77a-c000.snappy.parquet&#39;,</span>
<span class="go"> ...]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">vacuum</span><span class="p">(</span><span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1"># Don&#39;t run this unless you are sure!</span>
</pre></div>
</div>
</section>
<section id="optimizing-tables">
<h3>Optimizing tables<a class="headerlink" href="#optimizing-tables" title="Permalink to this headline"></a></h3>
<p>Optimizing a table will perform bin-packing on a Delta Table which merges small files
into a large file. Bin-packing reduces the number of API calls required for read operations.
Optimizing will increments the table’s version and creates remove actions for optimized files.
Optimize does not delete files from storage. To delete files that were removed, call <a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.vacuum" title="deltalake.table.DeltaTable.vacuum"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.vacuum()</span></code></a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">DeltaTable.optimize</span></code> returns a <a class="reference internal" href="api_reference.html#deltalake.table.TableOptimizer" title="deltalake.table.TableOptimizer"><code class="xref py py-class docutils literal notranslate"><span class="pre">TableOptimizer</span></code></a> object which provides
methods for optimizing the table. Note that these method will fail if a concurrent
writer performs an operation that removes any files (such as an overwrite).</p>
<p>For just file compaction, use the <a class="reference internal" href="api_reference.html#deltalake.table.TableOptimizer.compact" title="deltalake.table.TableOptimizer.compact"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TableOptimizer.compact()</span></code></a> method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/simple_table&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">compact</span><span class="p">()</span>
<span class="go">{&#39;numFilesAdded&#39;: 1, &#39;numFilesRemoved&#39;: 5,</span>
<span class="go"> &#39;filesAdded&#39;: {&#39;min&#39;: 555, &#39;max&#39;: 555, &#39;avg&#39;: 555.0, &#39;totalFiles&#39;: 1, &#39;totalSize&#39;: 555},</span>
<span class="go"> &#39;filesRemoved&#39;: {&#39;min&#39;: 262, &#39;max&#39;: 429, &#39;avg&#39;: 362.2, &#39;totalFiles&#39;: 5, &#39;totalSize&#39;: 1811},</span>
<span class="go"> &#39;partitionsOptimized&#39;: 1, &#39;numBatches&#39;: 1, &#39;totalConsideredFiles&#39;: 5,</span>
<span class="go"> &#39;totalFilesSkipped&#39;: 0, &#39;preserveInsertionOrder&#39;: True}</span>
</pre></div>
</div>
<p>For improved data skipping, use the <a class="reference internal" href="api_reference.html#deltalake.table.TableOptimizer.z_order" title="deltalake.table.TableOptimizer.z_order"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TableOptimizer.z_order()</span></code></a> method. This
is slower than just file compaction, but can improve performance for queries that
filter on multiple columns at once.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/COVID-19_NYT&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">z_order</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;county&quot;</span><span class="p">])</span>
<span class="go">{&#39;numFilesAdded&#39;: 1, &#39;numFilesRemoved&#39;: 8,</span>
<span class="go"> &#39;filesAdded&#39;: {&#39;min&#39;: 2473439, &#39;max&#39;: 2473439, &#39;avg&#39;: 2473439.0, &#39;totalFiles&#39;: 1, &#39;totalSize&#39;: 2473439},</span>
<span class="go"> &#39;filesRemoved&#39;: {&#39;min&#39;: 325440, &#39;max&#39;: 895702, &#39;avg&#39;: 773810.625, &#39;totalFiles&#39;: 8, &#39;totalSize&#39;: 6190485},</span>
<span class="go"> &#39;partitionsOptimized&#39;: 0, &#39;numBatches&#39;: 1, &#39;totalConsideredFiles&#39;: 8,</span>
<span class="go"> &#39;totalFilesSkipped&#39;: 0, &#39;preserveInsertionOrder&#39;: True}</span>
</pre></div>
</div>
</section>
</section>
<section id="writing-delta-tables">
<h2>Writing Delta Tables<a class="headerlink" href="#writing-delta-tables" title="Permalink to this headline"></a></h2>
<p>For overwrites and appends, use <a class="reference internal" href="api_reference.html#deltalake.write_deltalake" title="deltalake.write_deltalake"><code class="xref py py-func docutils literal notranslate"><span class="pre">write_deltalake()</span></code></a>. If the table does not
already exist, it will be created. The <code class="docutils literal notranslate"><span class="pre">data</span></code> parameter will accept a Pandas
DataFrame, a PyArrow Table, or an iterator of PyArrow Record Batches.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">write_deltalake</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">write_deltalake</span><span class="p">(</span><span class="s1">&#39;path/to/table&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="api_reference.html#deltalake.write_deltalake" title="deltalake.write_deltalake"><code class="xref py py-func docutils literal notranslate"><span class="pre">write_deltalake()</span></code></a> accepts a Pandas DataFrame, but will convert it to
a Arrow table before writing. See caveats in <a class="reference external" href="https://arrow.apache.org/docs/python/pandas.html" title="(in Apache Arrow v13.0.0)"><span>Pandas Integration</span></a>.</p>
</div>
<p>By default, writes create a new table and error if it already exists. This is
controlled by the <code class="docutils literal notranslate"><span class="pre">mode</span></code> parameter, which mirrors the behavior of Spark’s
<a class="reference external" href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.sql/api/pyspark.sql.DataFrameWriter.saveAsTable.html#pyspark.sql.DataFrameWriter.saveAsTable" title="(in PySpark vmaster)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyspark.sql.DataFrameWriter.saveAsTable()</span></code></a> DataFrame method. To overwrite pass in <code class="docutils literal notranslate"><span class="pre">mode='overwrite'</span></code> and
to append pass in <code class="docutils literal notranslate"><span class="pre">mode='append'</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">write_deltalake</span><span class="p">(</span><span class="s1">&#39;path/to/table&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;overwrite&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">write_deltalake</span><span class="p">(</span><span class="s1">&#39;path/to/table&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;append&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="api_reference.html#deltalake.write_deltalake" title="deltalake.write_deltalake"><code class="xref py py-meth docutils literal notranslate"><span class="pre">write_deltalake()</span></code></a> will raise <code class="xref py py-exc docutils literal notranslate"><span class="pre">ValueError</span></code> if the schema of
the data passed to it differs from the existing table’s schema. If you wish to
alter the schema as part of an overwrite pass in <code class="docutils literal notranslate"><span class="pre">overwrite_schema=True</span></code>.</p>
</section>
<section id="updating-delta-tables">
<h2>Updating Delta Tables<a class="headerlink" href="#updating-delta-tables" title="Permalink to this headline"></a></h2>
<p>Row values in an existing delta table can be updated with the <a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.update" title="deltalake.table.DeltaTable.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.update()</span></code></a> command. A update
dictionary has to be passed, where they key is the column you wish to update, and the value is a
Expression in string format.</p>
<p>Update all the rows for the column “processed” to the value True.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">write_deltalake</span><span class="p">,</span> <span class="n">DeltaTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;deleted&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">write_deltalake</span><span class="p">(</span><span class="s1">&#39;path/to/table&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s1">&#39;path/to/table&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;processed&quot;</span><span class="p">:</span> <span class="s2">&quot;True&quot;</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">x</span>       <span class="n">processed</span>
<span class="go">0       1       True</span>
<span class="go">1       2       True</span>
<span class="go">2       3       True</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.update" title="deltalake.table.DeltaTable.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.update()</span></code></a> predicates and updates are all in string format. The predicates and expressions,
are parsed into Apache Datafusion expressions.</p>
</div>
<p>Apply a soft deletion based on a predicate, so update all the rows for the column “deleted” to the value
True where x = 3</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">write_deltalake</span><span class="p">,</span> <span class="n">DeltaTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;deleted&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">write_deltalake</span><span class="p">(</span><span class="s1">&#39;path/to/table&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s1">&#39;path/to/table&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<span class="gp">... </span>   <span class="n">updates</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="s2">&quot;True&quot;</span><span class="p">},</span>
<span class="gp">... </span>   <span class="n">predicate</span><span class="o">=</span> <span class="s1">&#39;x = 3&#39;</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">x</span>       <span class="n">deleted</span>
<span class="go">0       1       False</span>
<span class="go">1       2       False</span>
<span class="go">2       3       True</span>
</pre></div>
</div>
<section id="overwriting-a-partition">
<h3>Overwriting a partition<a class="headerlink" href="#overwriting-a-partition" title="Permalink to this headline"></a></h3>
<p>You can overwrite a specific partition by using <code class="docutils literal notranslate"><span class="pre">mode=&quot;overwrite&quot;</span></code> together
with <code class="docutils literal notranslate"><span class="pre">partition_filters</span></code>. This will remove all files within the matching
partition and insert your data as new files. This can only be done on one
partition at a time. All of the input data must belong to that partition or else
the method will raise an error.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">write_deltalake</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">write_deltalake</span><span class="p">(</span><span class="s1">&#39;path/to/table&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">])</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s1">&#39;path/to/table&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">100</span><span class="p">],</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">write_deltalake</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">df2</span><span class="p">,</span> <span class="n">partition_filters</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">)],</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="go">     x  y</span>
<span class="go">0    1  a</span>
<span class="go">1    2  a</span>
<span class="go">2  100  b</span>
</pre></div>
</div>
<p>This method could also be used to insert a new partition if one doesn’t already
exist, making this operation idempotent.</p>
</section>
<section id="removing-data">
<h3>Removing data<a class="headerlink" href="#removing-data" title="Permalink to this headline"></a></h3>
<p>You can remove rows from a table with <a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.delete" title="deltalake.table.DeltaTable.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.delete()</span></code></a>. A SQL where clause can
be provided to only remove some rows. If the clause matches some partition values, then
the files under those partition values will be removed. If the clause matches rows
inside some files, then those files will rewritten without the matched rows. Omitting
the clause will remove all files from the table.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">deltalake</span> <span class="kn">import</span> <span class="n">DeltaTable</span><span class="p">,</span> <span class="n">write_deltalake</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;to_delete&#39;</span><span class="p">:</span> <span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">]})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">write_deltalake</span><span class="p">(</span><span class="s1">&#39;path/to/table&#39;</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">table</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s1">&#39;path/to/table&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">table</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">predicate</span><span class="o">=</span><span class="s2">&quot;to_delete = true&quot;</span><span class="p">)</span>
<span class="go">{&#39;num_added_files&#39;: 1, &#39;num_removed_files&#39;: 1, &#39;num_deleted_rows&#39;: 1, &#39;num_copied_rows&#39;: 2, &#39;execution_time_ms&#39;: 11081, &#39;scan_time_ms&#39;: 3721, &#39;rewrite_time_ms&#39;: 7}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">table</span><span class="o">.</span><span class="n">to_pandas</span><span class="p">()</span>
<span class="go">   a  to_delete</span>
<span class="go">0  1      False</span>
<span class="go">1  2      False</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.delete" title="deltalake.table.DeltaTable.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.delete()</span></code></a> does not delete files from storage but only updates the
table state to one where the deleted rows are no longer present. See
<a class="reference internal" href="#vacuuming-tables">Vacuuming tables</a> for more information.</p>
</div>
</section>
<section id="restoring-tables">
<h3>Restoring tables<a class="headerlink" href="#restoring-tables" title="Permalink to this headline"></a></h3>
<p>Restoring a table will restore delta table to a specified version or datetime. This
operation compares the current state of the delta table with the state to be restored.
And add those missing files into the AddFile actions and add redundant files into
RemoveFile actions. Then commit into a new version.</p>
<p>Use <a class="reference internal" href="api_reference.html#deltalake.table.DeltaTable.restore" title="deltalake.table.DeltaTable.restore"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeltaTable.restore()</span></code></a> to perform the restore operation. Note that if any other
concurrent operation was performed on the table, restore will fail.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span> <span class="o">=</span> <span class="n">DeltaTable</span><span class="p">(</span><span class="s2">&quot;../rust/tests/data/simple_table&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dt</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">{&#39;numRemovedFile&#39;: 5, &#39;numRestoredFile&#39;: 22}</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="installation.html" class="btn btn-neutral float-left" title="Installation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="api_reference.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021 delta-rs contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>